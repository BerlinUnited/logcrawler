image: docker:latest
services:
 - docker:dind

variables:
    # https://about.gitlab.com/blog/2019/07/31/docker-in-docker-with-docker-19-dot-03/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_IMAGE: scm.cms.hu-berlin.de:4567/berlinunited/projects/log-crawler

build_image:
  tags:
    - goal
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN scm.cms.hu-berlin.de:4567
    - docker build -f Dockerfile -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:latest

deploy_k8s:
  tags:
    - goal
  # https://gitlab.com/gitlab-org/gitlab-foss/-/issues/65110
  image: 
    name: bitnami/kubectl:1.28.2
    entrypoint: [""]
  script:
    - export KUBECONFIG=$KUBECONFIG_FILE
    # https://stackoverflow.com/questions/38216278/update-k8s-configmap-or-secret-without-deleting-the-existing-one
    - kubectl create configmap logcrawler --from-file=main.py -n default -o yaml --dry-run=client | kubectl apply -f -
    - kubectl apply -f log_crawler.yaml -n default