image: docker:latest
services:
 - docker:dind

before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN scm.cms.hu-berlin.de:4567

variables:
    # https://about.gitlab.com/blog/2019/07/31/docker-in-docker-with-docker-19-dot-03/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
    DOCKER_IMAGE: scm.cms.hu-berlin.de:4567/berlinunited/projects/log-crawler

build_image:
  tags:
    - goal
  script:
    - docker build -f Dockerfile -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:latest

deploy_k8s:
  tags:
    - goal
  image: 
    name: bitnami/kubectl:1.28.2
    entrypoint: [""]
  script:
    - export KUBECONFIG=$KUBECONFIG_FILE
    - kubectl create configmap logcrawler --from-file=main.py -n default
    - kubectl apply -f log_crawler.yaml